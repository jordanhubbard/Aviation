openapi: 3.0.0
info:
  title: Aviation Accident Tracker API
  version: 0.1.0
  description: |
    REST API for ingesting, managing, and retrieving aviation accident and incident data.
    
    Data is sourced from ASN (Aviation Safety Network) and AVHerald, normalized, deduplicated,
    and made available through filtered queries with full provenance tracking.
    
    ## Features
    - Event ingestion from multiple sources
    - Smart deduplication
    - Advanced filtering (date, category, location, text search)
    - Pagination support
    - Full source provenance
    - Airport search integration
    
  contact:
    name: Aviation Monorepo
    url: https://github.com/jordanhubbard/Aviation
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: https://api.accident-tracker.example.com
    description: Production server

tags:
  - name: events
    description: Aviation accident/incident events
  - name: ingestion
    description: Data ingestion operations
  - name: filters
    description: Filter helper endpoints
  - name: health
    description: Health and status endpoints

paths:
  /health:
    get:
      summary: Health check endpoint
      description: Returns the health status of the API server
      tags:
        - health
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy]
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time
                    example: '2024-01-14T10:30:00.000Z'
                  env:
                    type: string
                    enum: [development, production]
                    example: development

  /version:
    get:
      summary: Get API version
      description: Returns the current version of the API
      tags:
        - health
      responses:
        '200':
          description: Version information
          content:
            application/json:
              schema:
                type: object
                properties:
                  version:
                    type: string
                    example: '0.1.0'
                  service:
                    type: string
                    example: accident-tracker

  /api/events:
    get:
      summary: List aviation events
      description: |
        Retrieve a paginated list of aviation accident/incident events with optional filtering.
        
        Supports filtering by:
        - Date range (from/to)
        - Category (general aviation vs commercial)
        - Location (airport, country, region)
        - Text search (registration, operator, summary)
      tags:
        - events
      parameters:
        - name: from
          in: query
          description: Start date (ISO 8601 format, e.g., 2024-01-01)
          schema:
            type: string
            format: date
            example: '2024-01-01'
        - name: to
          in: query
          description: End date (ISO 8601 format)
          schema:
            type: string
            format: date
            example: '2024-12-31'
        - name: category
          in: query
          description: Event category filter
          schema:
            type: string
            enum: [all, general, commercial]
            default: all
        - name: airport
          in: query
          description: Airport ICAO or IATA code
          schema:
            type: string
            example: KSFO
        - name: country
          in: query
          description: Country code
          schema:
            type: string
            example: USA
        - name: region
          in: query
          description: Region or state code
          schema:
            type: string
            example: CA
        - name: search
          in: query
          description: Text search across registration, operator, and summary
          schema:
            type: string
            example: N12345
        - name: limit
          in: query
          description: Maximum number of results per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          description: Number of results to skip (for pagination)
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of events matching the criteria
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/Event'
                  total:
                    type: integer
                    description: Total number of matching events
                    example: 157
                  limit:
                    type: integer
                    example: 50
                  offset:
                    type: integer
                    example: 0
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/events/{id}:
    get:
      summary: Get event by ID
      description: Retrieve detailed information about a specific event including all sources
      tags:
        - events
      parameters:
        - name: id
          in: path
          required: true
          description: Event ID
          schema:
            type: string
            example: '42'
      responses:
        '200':
          description: Event details with sources
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Event'
                  - type: object
                    properties:
                      sources:
                        type: array
                        items:
                          $ref: '#/components/schemas/Source'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/ingest/run:
    post:
      summary: Trigger manual ingestion
      description: |
        Manually trigger data ingestion from configured sources.
        
        Requires Bearer token authentication.
      tags:
        - ingestion
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                source:
                  type: string
                  enum: [asn, avherald]
                  description: Specific source to ingest (omit for all)
                  example: asn
                windowDays:
                  type: integer
                  description: Number of days to look back
                  minimum: 1
                  maximum: 365
                  default: 40
                  example: 40
      responses:
        '200':
          description: Ingestion completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [completed]
                    example: completed
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        source:
                          type: string
                          example: asn
                        eventsIngested:
                          type: integer
                          example: 12
                        eventsUpdated:
                          type: integer
                          example: 3
                        errors:
                          type: integer
                          example: 0
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/airports:
    get:
      summary: Search airports
      description: Search airports by ICAO/IATA code or name
      tags:
        - filters
      parameters:
        - name: search
          in: query
          required: true
          description: Search query (ICAO, IATA, or name)
          schema:
            type: string
            minLength: 1
            example: SFO
      responses:
        '200':
          description: List of matching airports
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Airport'
                maxItems: 20

  /api/filters/options:
    get:
      summary: Get available filter options
      description: Returns lists of available countries and regions for filtering
      tags:
        - filters
      responses:
        '200':
          description: Filter options
          content:
            application/json:
              schema:
                type: object
                properties:
                  countries:
                    type: array
                    items:
                      type: string
                    example: ['USA', 'Canada', 'Mexico']
                  regions:
                    type: array
                    items:
                      type: string
                    example: ['CA', 'NY', 'TX', 'FL']

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: Bearer token for ingestion endpoint

  schemas:
    Event:
      type: object
      properties:
        id:
          type: string
          example: '42'
        dateZ:
          type: string
          format: date-time
          description: Event date in UTC/Zulu time
          example: '2024-01-15T10:30:00Z'
        registration:
          type: string
          description: Aircraft registration (e.g., N-number)
          example: N12345
        aircraftType:
          type: string
          nullable: true
          example: Cessna 172
        operator:
          type: string
          nullable: true
          example: Private Owner
        category:
          type: string
          enum: [general, commercial, unknown]
          description: Classification of operation
          example: general
        airportIcao:
          type: string
          nullable: true
          example: KSFO
        airportIata:
          type: string
          nullable: true
          example: SFO
        latitude:
          type: number
          format: float
          nullable: true
          example: 37.6188
        longitude:
          type: number
          format: float
          nullable: true
          example: -122.375
        country:
          type: string
          nullable: true
          example: USA
        region:
          type: string
          nullable: true
          example: CA
        fatalities:
          type: integer
          minimum: 0
          default: 0
          example: 0
        injuries:
          type: integer
          minimum: 0
          default: 0
          example: 0
        summary:
          type: string
          nullable: true
          description: Brief summary of the event
          example: Engine failure on approach
        narrative:
          type: string
          nullable: true
          description: Detailed description of the event
          example: Aircraft experienced sudden engine failure during final approach...
        status:
          type: string
          nullable: true
          enum: [preliminary, final, ongoing]
          example: final
        createdAt:
          type: string
          format: date-time
          example: '2024-01-15T11:00:00Z'
        updatedAt:
          type: string
          format: date-time
          example: '2024-01-15T11:00:00Z'

    Source:
      type: object
      properties:
        id:
          type: string
          example: '101'
        sourceName:
          type: string
          enum: [asn, avherald]
          example: asn
        url:
          type: string
          format: uri
          example: https://aviation-safety.net/database/record.php?id=20240115-0
        fetchedAt:
          type: string
          format: date-time
          example: '2024-01-15T12:00:00Z'
        checksum:
          type: string
          nullable: true
          description: Hash of source content for change detection
          example: abc123def456
        rawFragment:
          type: string
          nullable: true
          description: Raw HTML/JSON snippet from source

    Airport:
      type: object
      properties:
        icao:
          type: string
          example: KSFO
        iata:
          type: string
          nullable: true
          example: SFO
        name:
          type: string
          example: San Francisco International Airport
        country:
          type: string
          example: USA
        region:
          type: string
          nullable: true
          example: CA
        latitude:
          type: number
          format: float
          example: 37.6188
        longitude:
          type: number
          format: float
          example: -122.375

    Error:
      type: object
      properties:
        error:
          type: string
          example: Not found
        message:
          type: string
          example: Event 999 not found
        path:
          type: string
          example: /api/events/999

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Not found
            message: Event 999 not found

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Unauthorized
            message: Bearer token required

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Forbidden
            message: Invalid token

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Internal server error
            message: Database connection failed
